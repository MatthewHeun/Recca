---
title: "Balances"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Balances}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(dplyr)
library(IEATools)
library(Recca)
library(tidyr)
```


## Introduction

When working with material and energy conversion chains 
in the `Recca` package with `matsindf` data frames,
it is helpful to calculate several types of balances.
This vignette describes those balances and shows
when you might want to use each of them.
Balances include

* inter-industry balances,
* intra-industry balances, and
* the $\mathbf{W}$ matrix.


### Terminology

`Recca` assists with matrix-based input-output calculations
when the data are organized into the 
$\mathbf{RUVY}$ matrices of the 
physical supply-use table (PSUT) framework.
A generic processing stage is called an "industry."
The stuff that flows between industries is generically
called a "product." 
A "balance" is any calculation that compares inputs to outputs.
Balances can be computed for all types of products, 
in particular materials (quantified in mass or exergy units)
and energy (quantified as energy or exergy).

In the PSUT framework, 
the $\mathbf{R}$ matrix is an industry-by-product resource matrix.
The $\mathbf{U}$ matrix is an product-by-industry use matrix.
The $\mathbf{V}$ matrix is an industry-by-product make matrix.
The $\mathbf{Y}$ matrix is an product-by-industry final demand matrix.

In this vignette, matrices are represented by boldface 
capital letters, such as $\mathbf{R}$.
Vectors are assumed to be column vectors and
represented by boldface lowercase letters, 
such as the identity vector $\mathbf{i}$.


### Data

In the examples that follow, 
we use the energy conversion chain in `UKEnergy2000mats`
from the `Recca` package.

```{r}
ecc <- UKEnergy2000mats |> 
  tidyr::pivot_wider(names_from = matrix.name, 
                     values_from = matrix)
dplyr::glimpse(ecc)
```


## Balances

The following subsections explain
each type of balance and how to calculate
it with the `Recca` package.


### Inter-industry (between-industry) balances check for product consistency

In any conversion chain, 
products that leave one industry must enter another industry.
Inter-industry balances are a product balance
that ensures that the total supply of any product
is equal to the total use of any product
within the conversion chain.
These inter-industry (or between-industry) balances
should be verified for every conversion chain
to ensure consistency.

Inter-industry balances
are obtained
by the following computation.

$$[(\mathbf{R} + \mathbf{V})^\mathrm{T} 
     - (\mathbf{U} + \mathbf{Y})] \, \mathbf{i}$$

If the conversion chain is consistent, 
the result should be the $\mathbf{0}$ vector 
with products in rows.

To compute inter-industry balances within the PSUT framework
using the `Recca` package, 
use the following code.

```{r}
inter_industry_balances <- ecc |> 
  calc_inter_industry_balance()
```

The result is added as a new column,
named "SUTInterIndustryBalance" by default.

```{r}
dplyr::glimpse(inter_industry_balances)
```

The vectors in SUTInterIndustryBalance column have products in rows.

```{r}
inter_industry_balances$SUTInterIndustryBalance[[1]]
inter_industry_balances$SUTInterIndustryBalance[[2]]
inter_industry_balances$SUTInterIndustryBalance[[3]]
inter_industry_balances$SUTInterIndustryBalance[[4]]
```

As expected, these vectors are the $\mathbf{0}$ vector to within 
reasonable precision.

To check the inter-industry balances for consistency, 
use `verify_inter_industry_balance()`.
The `tol` argument gives the tolerance for
non-zero product balances.

```{r}
inter_industry_balances |> 
  verify_inter_industry_balance(tol = 1e-4) |> 
  dplyr::glimpse()
```

To calculate and verify the balances 
without adding any columns to the data frame, 
set `delete_balance_cols_if_verified = TRUE`.

```{r}
inter_industry_balances |> 
  verify_inter_industry_balance(tol = 1e-4, 
                                delete_balance_cols_if_verified = TRUE) |> 
  dplyr::glimpse()
```


If a product is out of balance 
by more than `tol` (by default `1e-6`), 
a warning occurs and 
`FALSE` appears in the new column, 
"SUTInterIndustryBalanced."


### Intra-industry (across-industry) balances

A second type of balance
(the intra-industry balance)
computes differences _across_ industries,
inputs ($\mathbf{U}$) less outputs ($\mathbf{V}$).
Intra-industry balances
are obtained by the following computation.

$$(\mathbf{U}^\mathrm{T} - \mathbf{V}) \, \mathbf{i}$$

The result is a column vector with 
industries in rows.
In the resultant column vector, 
losses are positive values.

The interpretation of the results depends upon 
the construction of the matrices.
In a PSUT description of conserved quantities
(such as mass or energy),
when all losses are accounted within the matrices themselves,
the calculation of intra-industry balances should give
the $\mathbf{0}$ vector.
When losses _are not_ accounted in the matrices,
the calculation of intra-industry balances gives losses.

For PSUT matrices describing non-conserved quantities
such as exergy
(mass exergy, energy exergy, or both),
when losses _are_ accounted in the matrices,
the intra-industry balance gives destruction
of the non-conserved quantity.
When losses _are not_ accounted in the matrices,
the intra-industry balance gives the sum of
destruction and losses.

The following table summarizes the above points,
giving the result of intra-industry balances
for various conversion chain types,
depending on whether the matrices include losses.

| Matrices contain              | Matrices include losses (wastes)  | Matrices exclude losses (wastes) |
| :---------------------------: | :-------------------------------: | :------------------------------: |
| Mass (MCC)                    | $\mathbf{0}$                      | $\mathbf{m}_L$                   |
| Energy (ECC)                  | $\mathbf{0}$                      | $\mathbf{e}_L$                   |
| Mass exergy (BCC)             | $\mathbf{b}_D$                    | $\mathbf{b}_D + \mathbf{b}_L$    |
| Energy exergy (XCC)           | $\mathbf{x}_D$                    | $\mathbf{x}_D + \mathbf{x}_L$    |
| Mass and energy exergy (BXCC) | $\mathbf{b}_D + \mathbf{x}_D$     | $\mathbf{b}_D + \mathbf{b}_L + \mathbf{x}_D + \mathbf{x}_L$  |

MCC indicates a material conversion chain.
ECC indicates an energy conversion chain.
BCC indicates a material exergy conversion chain.
XCC indicates an energy exergy conversion chain.
BXCC indicates a combined material and energy exergy conversion chain.
$\mathbf{0}$ indicates the result is the zero vector;
$\mathbf{m}$ indicates the result is a mass vector;
$\mathbf{e}$ indicates the result is an energy vector;
$\mathbf{b}$ indicates the result is a mass exergy vector; and
$\mathbf{x}$ indicates the result is an energy exergy vector.
Subscript $L$ indicates losses (or wastes), and 
subscript $D$ indicates exergy destroyed by the industry.


To compute intra-industry (across-industry) balances
within the PSUT framework using the `Recca` package, 
use the following code.

```{r}
intra_industry_balances <- ecc |> 
  dplyr::filter(EnergyType == "E" & (LastStage %in% c("Final", "Useful"))) |> 
  calc_intra_industry_balance()
```

The result is added as a new column,
named "SUTIntraIndustryBalance" by default.

```{r}
dplyr::glimpse(intra_industry_balances)
```

Unsurprisingly, a warning is issued, because
verification is unsuccessful.

```{r}
intra_industry_balances |> 
  verify_intra_industry_balance() |> 
  glimpse()
```

The vectors in the "SUTIntraIndustryBalance" column have industries in rows.

```{r}
intra_industry_balances$SUTIntraIndustryBalance[[1]]
intra_industry_balances$SUTIntraIndustryBalance[[2]]
```

Because the matrices in `ecc` do not contain losses, 
`calc_intra_industry_balance()` calculates energy losses 
(waste heat and waste products)
($\mathbf{e}_L$ in the table above).


### Endogenizing losses

The losses can be endogenized, 
i.e., added to the $\mathbf{RUVY}$ matrices of the PSUT framework.
To do so, 
use `endogenize_losses()`.
But first, one needs to allocate the losses from each sector to a 
particular type of product or set of products.
The allocation of losses to products is accomplished by a matrix
with industries in rows and loss products in columns.
The rows of the loss allocation matrix must sum to 1.
The `losses_alloc_colname` column 
(by default `Recca::balance_cols$losses_alloc_colname`
or "`r Recca::balance_cols$losses_alloc_colname`")
contains those matrices.

A default loss allocation matrix 
(that allocates losses from every industry to "Waste heat")
is given in `Recca::balance_cols$default_losses_alloc_mat`.

```{r}
Recca::balance_cols$default_losses_alloc_mat
```

To use a default losses allocation matrix, 
add a matrix column of loss allocations
as shown below.

```{r}
iibs_with_loss_allocs <- intra_industry_balances |> 
  dplyr::mutate(
    "{Recca::balance_cols$losses_alloc_colname}" :=
      RCLabels::make_list(Recca::balance_cols$default_losses_alloc,
                          n = dplyr::n(),
                          lenx = 1)
  )
```

Now, endogenizing the losses proceeds with a call to 
`endogenize_losses()`.

```{r}
endogenized <- iibs_with_loss_allocs |> 
  endogenize_losses()
```

`endogenize_losses()` adds two new columns:
by default `V_prime` and `Y_prime`.
`V_prime` and `Y_prime` contain $\mathbf{V}$ and $\mathbf{Y}$ matrices
with losses included directly in the matrices.
In the example, 
the $\mathbf{V}^{\prime}$ matrices contain a new column
(named "Waste heat" by default)
that shows the heat losses from each industry.

```{r}
endogenized$V_prime[[1]]
```

The $\mathbf{Y}^{\prime}$ matrices also have a new column, 
by default named "Losses."

```{r}
endogenized$Y_prime[[1]]
```

In addition, 
the $\mathbf{Y}^{\prime}$ matrices contain a new row 
(again named "Waste heat" by default)
that shows the total heat loss in a 
new "Losses" column. 

To accept the endogenized matrices, 
set `replace_cols = TRUE`.

```{r}
endogenized2 <- iibs_with_loss_allocs |> 
  endogenize_losses(replace_cols = TRUE) 
dplyr::glimpse(endogenized2)
endogenized2$Y[[1]] # Same as endogenized$Y_prime[[1]]
```


### The value added matrix ($\mathbf{W}$)

The value added matrix ($\mathbf{W}$) 
obtained from `calc_yqfgW()` is similar
to but different from
the balances obtained from
`calc_inter_industry_balance()` and
`calc_intra_industry_balance()`. 
The following equations show the similarities and differences.

The value added matrix ($\mathbf{W}$) is 

$$\mathbf{W} = \mathbf{V}^{\mathrm{T}} - \mathbf{U}$$

Inter-industry balances are calculated by

$$[(\mathbf{R} + \mathbf{V})^\mathrm{T}  - (\mathbf{U} + \mathbf{Y})] \mathbf{i}$$

and the intra-industry balances are calculated by

$$(\mathbf{U}^\mathrm{T} - \mathbf{V})  \mathbf{i} \, .$$

The value added matrix ($\mathbf{W}$) is closest to the intra-industry balances, 
but 

* with the opposite sense
  (in $\mathbf{W}$ products are in rows; 
  in the intra-industry balances, industries are in rows), 
* without summation by the unit vector ($\mathbf{i}$),
and 
* with opposite sign
  (in $\mathbf{W}$, losses are negative; 
  in the intra-industry balance, 
  losses are positive).

The following code shows the comparison
between $\mathbf{W}$ and intra-industry balances.

```{r}
compare <- ecc |> 
  calc_yqfgW() |> 
  calc_intra_industry_balance()
# Calculate column sums of W and 
# transpose to create a column vector 
# for easier comparison
compare$W[[1]] |> 
  matsbyname::colsums_byname() |> 
  matsbyname::transpose_byname()
# Compare to the intra-industry balance
compare$SUTIntraIndustryBalance[[1]]
```


### Deprecated functions

Two related functions in the `Recca` package
have been deprecated and will soon be removed.

#### `verify_SUT_energy_balance()`

`verify_SUT_energy_balance()` has been deprecated for two reasons.

* `verify_SUT_energy_balance()` unfortunately combined
`calc_inter_industry_balance()` and
`verify_inter_industry_balance()` in a single step.
We often need to know the balances independently
from whether products are balanced.
The combination of 
`calc_inter_industry_balance()` and
`verify_inter_industry_balance()`
provides the needed flexibility.
* Using "energy" in the name of the function was an unfortunate choice,
because we can use the same mathematics to balance masses
or exergies.
The new function names are independent of the type products
in the $\mathbf{RUVY}$ matrices and are,
therefore, an improvement.

For now, `verify_SUT_energy_balance()`
remains in the `Recca` package but will 
likely be removed at a later date.


#### `verify_SUT_energy_balance_with_units()`

`verify_SUT_energy_balance_with_units()` seemed like a good 
idea at the time, but we have never used it.
For now, `verify_SUT_energy_balance_with_units()`
remains in the `Recca` package but will 
likely be removed at a later date.


## Conclusion

There are several types of balances that are of interest
to energy and material conversion chain analysts.
The functions
`calc_inter_industry_balance()`, 
`verify_inter_industry_balance()`, 
`calc_intra_industry_balance()`, 
`verify_intra_industry_balance()`, and
`endogenize_losses()`
assist with those analyses. 
