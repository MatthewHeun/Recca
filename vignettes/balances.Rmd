---
title: "Balances"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Balances}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(dplyr)
library(IEATools)
library(Recca)
```


## Introduction

When working with material and energy conversion chains 
in the `Recca` package with `matsindf` data frames,
it is helpful to calculate several types of balances.
This vignette describes those balances and shows
when you might want to use each of them.
Balances include

* inter-industry balances,
* intra-industry balances, and
* the $\mathbf{W}$ matrix.


### Terminology

`Recca` assists with matrix-based input-output calculations
when the data are organized into the 
$\mathbf{RUVY}$ matrices of the 
physical supply-use table (PSUT) framework.
A generic processing stage is called an "industry."
The name for items that flow between industries is "product." 
A "balance" is any calculation that compares inputs to outputs.
Balances can be computed for all types of products, 
in particular materials (quantified in mass or exergy units)
and energy (quantified as energy or exergy).

In the PSUT framework, 
the $\mathbf{R}$ matrix is an industry-by-product resource matrix.
The $\mathbf{U}$ matrix is an product-by-industry use matrix.
The $\mathbf{V}$ matrix is an industry-by-product make matrix.
The $\mathbf{Y}$ matrix is an product-by-industry final demand matrix.

In this vignette, matrices are represented by boldface 
capital letters, such as $\mathbf{R}$.
Vectors are assumed to be column vectors and
represented by boldface lowercase letters, 
such as the identity vector $\mathbf{i}$.


### Data

In the examples that follow, 
we use the energy conversion chain in `UKEnergy2000mats`.

```{r}
ecc <- UKEnergy2000mats |> 
  tidyr::pivot_wider(names_from = matrix.name, 
                     values_from = matrix) |> 
  dplyr::filter(.data[[IEATools::iea_cols$last_stage]] %in%
                  c(IEATools::last_stages$final, IEATools::last_stages$useful))
dplyr::glimpse(ecc)
```


## Balances

The following subsections explain
each type of balance and how to calculate
it with the `Recca` package.


### Inter-industry balances for product consistency checks

In any conversion chain, 
products that leave one industry must enter another industry.
These between industry (or inter-industry) balances
should be verified for every conversion chain.

The inter-industry balances are calculated 
by the following matrix equation.

$$[(\mathbf{R} + \mathbf{V})^\mathrm{T} 
     - (\mathbf{U} + \mathbf{Y})] \, \mathbf{i}$$

If the conversion chain is consistent, 
the result should be the $\mathbf{0}$ vector 
with products in rows.

To compute inter-industry balances within the PSUT framework
using the `Recca` package, 
use the following code.

```{r}
inter_industry_balances <- ecc |> 
  calc_inter_industry_balance()
```

The result is added as a new column,
named "SUTInterIndustryBalance" by default.

```{r}
glimpse(inter_industry_balances)
```

The vectors in SUTInterIndustryBalance are product vectors.

```{r}
inter_industry_balances$SUTInterIndustryBalance[[1]]
inter_industry_balances$SUTInterIndustryBalance[[2]]
```

As expected, these are the $\mathbf{0}$ vector to within 
reasonable precision.

If you want to check the inter-industry balances for consistency, 
use `verify_inter_industry_balance()`.

```{r}
inter_industry_balances |> 
  verify_inter_industry_balance() |> 
  glimpse()
```

If a product is out of balance 
by more than `tol` (by default `1e-6`), 
a warning will occur and 
`FALSE` will appear in the new column, 
"SUTInterIndustryBalanced".


### Intra-industry balances to calculate losses

A second type of balance
(the intra-industry balance)
computes differences _across_ industries.
Typically, the intra-industry balance computes 
inputs less outputs, and 
the result is losses (wastes) as a positive number.

The matrix equation for intra-industry balances
is given by the following equation.

$$(\mathbf{U}^\mathrm{T} - \mathbf{V}) \, \mathbf{i}$$

The result is a column vector with industries in rows.

The meaning of intra-industry balances
depends upon the construction
of the matrices.
The following table shows meanings.

| Matrices contain              | Matrices include losses (wastes)  | Matrices exclude losses (wastes) |
| :---------------------------: | :-------------------------------: | :------------------------------: |
| Mass (MCC)                    | $\mathbf{0}$                      | $\mathbf{M}_L$                   |
| Energy (ECC)                  | $\mathbf{0}$                      | $\mathbf{E}_L$                   |
| Mass exergy (BCC)             | $\mathbf{B}_D$                    | $\mathbf{B}_D + \mathbf{B}_L$    |
| Energy exergy (XCC)           | $\mathbf{X}_D$                    | $\mathbf{X}_D + \mathbf{X}_L$    |
| Mass and energy exergy (BXCC) | $\mathbf{BX}_D$                   | $\mathbf{BX}_D + \mathbf{BX}_L$  |


### The value added matrix ($\mathbf{W}$)





































