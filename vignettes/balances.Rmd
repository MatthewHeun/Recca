---
title: "Balances"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Balances}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(dplyr)
library(IEATools)
library(Recca)
```


## Introduction

When working with material and energy conversion chains 
in the `Recca` package with `matsindf` data frames,
it is helpful to calculate several types of balances.
This vignette describes those balances and shows
when you might want to use each of them.


## Terminology

`Recca` assists with matrix-based input-output calculations
when the data are organized into the 
$\mathbf{RUVY}$ matrices of the 
physical supply-use table (PSUT) framework.
A generic processing stage is called an "industry."
The name for items that flow between industries is "product." 
A "balance" is any calculation that compares inputs to outputs.
Balances can be computed for all types of products, 
in particular materials (quantified in mass or exergy units)
and energy (quantified as energy or exergy).

In the PSUT framework, 
the $\mathbf{R}$ matrix is an industry-by-product resource matrix.
The $\mathbf{U}$ matrix is an product-by-industry use matrix.
The $\mathbf{V}$ matrix is an industry-by-product make matrix.
The $\mathbf{Y}$ matrix is an product-by-industry final demand matrix.

In this vignette, matrices are represented by boldface 
capital letters, such as $\mathbf{R}$.
Vectors are assumed to be column vectors and
represented by boldface lowercase letters, 
such as the identity vector $\mathbf{i}$.


## Data

In the examples that follow, 
we use the energy conversion chain in `UKEnergy2000mats`.

```{r}
ecc <- UKEnergy2000mats |> 
  tidyr::pivot_wider(names_from = matrix.name, 
                     values_from = matrix) |> 
  dplyr::filter(.data[[IEATools::iea_cols$last_stage]] %in%
                  c(IEATools::last_stages$final, IEATools::last_stages$useful))
dplyr::glimpse(ecc)
```


## Inter-industry balances for consistency checks

In any conversion chain, 
products that leave one industry must enter another industry.
These between industry (or inter-industry) balances
should be verified for every conversion chain.

The inter-industry balances are represented 
by the following matrix equation.

$$[(\mathbf{R} + \mathbf{V})^\mathrm{T} 
     - (\mathbf{U} + \mathbf{Y})] \, \mathbf{i}$$

If the conversion chain is consistent, 
the result should be the $\mathbf{0}$ vector 
with products in rows.

To compute inter-industry balances within the PSUT framework, 
use the following code.

```{r}
inter_industry_balances <- ecc |> 
  calc_inter_industry_balance()
```

The result is added as a new column,
"SUTInterIndustryBalance" by default.

```{r}
glimpse(inter_industry_balances)
```

The vectors in SUTInterIndustryBalance are product vectors

```{r}
inter_industry_balances$SUTInterIndustryBalance[[1]]
inter_industry_balances$SUTInterIndustryBalance[[2]]
```
