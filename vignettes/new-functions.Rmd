---
title: "new_* functions"
author: "Matthew Kuperus Heun"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: recca.bib
vignette: >
  %\VignetteIndexEntry{new_* functions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(dplyr)
library(Recca)
library(magrittr)
library(matsbyname)
library(matsindf)
library(tidyr)
```

<!-- Establish some helpful LaTeX shortcuts for equations -->
\newcommand{\transpose}[1]{#1^\mathrm{T}}
\newcommand{\inverse}[1]{#1^{\mathrm{-}1}}
\newcommand{\mat}[1]{\mathbf{#1}}
\newcommand{\colvec}[1]{\mathbf{#1}}
\newcommand{\rowvec}[1]{\transpose{\colvec{#1}}}
\newcommand{\inversetranspose}[1]{\transpose{\left( \inverse{\mat{#1}} \right)}}
\newcommand{\transposeinverse}[1]{\inverse{\left( \transpose{\mat{#1}} \right)}}
\newcommand{\hatinv}[1]{\inverse{\widehat{#1}}}

## Introduction

`Recca` is an `R` package that builds upon input-output (I-O) analysis to analyze energy conversion chains (ECCs).
Historically, input-output (I-O) analysis has been used to analyze "what-if" scenarios involving
changes to the production structure of an economy. 
A common scenario asks "how will will the structure of intermediate industries
(represented by $\mat{U}$ and $\mat{V}$ matrices) change when final demand (represented by the $\mat{Y}$ matrix) changes?"
In the economic arena, Leontief's early work answered this question 
via a matrix inversion that now bears his name,
the "Leontief inverse ($\mat{L}$)" [@Leontief:1941].
Analysts with an I-O background will know the famous equation $\mat{L} = (\mat{I} - \mat{A})^{-1}$.

The `Recca` package provides functions that perform several "what if" analyses for the analyst.
Each function has the name `new_*`, where `*` indicates the changed matrix or portion of the ECC.
Some functions have the name `new_*_ps` to indicate the functions assume perfect substitution (`ps`)
of industry inputs throughout the ECC.
The `new_*` functions return the resource ($\mat{R}$), use ($\mat{U}$), make ($\mat{V}$), and final demand ($\mat{Y}$) matrices
that would be present under the conditions given by arguments to the `new_*` functions.
Arguments for "new" versions of vectors or matrices are given the suffix `_prime` in the `new_*` functions.
For example, the updated version of the use ($\mat{U}$) matrix is called `U_prime`.

For the examples that follow, we'll use the `UKEnergy2000mats` data frame.
Each row of `UKEnergy2000mats` data frame represents 
another version of a portion of the ECC for the UK in 2000.

After a short discussion of the inputs to the `new_*` functions, 
each type of analysis is described in turn.


## Inputs to `new_*` functions

Inputs to the `new_*` functions include
matrices that describe the ECC and 
matrices that describe the input-output structure of the ECC.


### $\mat{R}$, $\mat{U}$, $\mat{V}$, and $\mat{Y}$ matrices

The `new_*` functions take as inputs 
resource ($\mat{R}$), 
use ($\mat{U}$), 
make ($\mat{V}$), and 
final demand ($\mat{Y}$) matrices
that describe the ECC.
Earlier versions of `Recca` included the resource matrix ($\mat{R}$) 
with the make ($\mat{V}$) matrix.
To separate the resource matrix $\mat{R}$ from the make matrix ($\mat{V}$),
use the `separate_RV()` function.

```{r}
library(dplyr)
library(magrittr)
library(matsbyname)
library(matsindf)
library(Recca)
library(tidyr)
UKEnergyMatsWithR <- UKEnergy2000mats %>% 
  spread(key = "matrix.name", value = "matrix") %>% 
  # The following code is necessary until R matrices are included
  # in the UKEnergy2000mats data frame.
  rename(
    R_plus_V = V
  ) %>%
  separate_RV()
glimpse(UKEnergyMatsWithR)
```

To look at the ECC, we can draw a Sankey diagram. 
A Sankey diagram for the first row of the `UKEnergyMatsWithR` data frame is given below.

```{r, fig.width = 7, fig.height = 4}
make_sankey(UKEnergyMatsWithR) %>% 
  extract2("Sankey") %>% # Extracts the "Sankey" column
  extract2(1) # Extracts the first row of the "Sankey" column
```


### Input-output structure of the ECC

Each `new_*` function requires basic knowledge about the I-O structure of the ECCs
in the form of named vectors and matrices.
The `calc_io_mats` function is the simplest way to obtain the I-O structure
which appears as additional columns appended at the right of the data frame.
(The names of the additional columns are given by 
arguments to the `calc_io_mats()` function.)

The first step in any "what-if" analysis is to calculate the input-output 
structure of the energy conversion chain.
The `calc_io_mats()` function adds several columns to the `UKEnergyMatsWithR` data frame.

```{r}
IO_mats <- UKEnergyMatsWithR %>% 
  # Obtain the I-O structure of the ECCs
  calc_io_mats()
# Note additional columns appended to the data frame.
glimpse(IO_mats)
```

With the I-O structure of the ECC determined
(and represented by the $\colvec{q}$, $\colvec{f}$, and $\colvec{g}$ vectors and the 
$\mat{W}$, $\mat{Z}$, $\mat{K}$, $\mat{C}$, $\mat{D}$, $\mat{A}$, 
$\mat{L_{pxp}}$, and $\mat{L_{ixp}}$ matrices), 
we can use the `new_*` functions to ask "what if" questions.


## What if final demand changes? Function `new_Y()`

The classic I-O question is "what if final demand ($\mat{Y}$) changes?"
`Recca` has a function for that.
Let's test it by doubling the final demand in every ECC.

```{r}
DoubleY <- IO_mats %>% 
  mutate(
    Y_prime = hadamardproduct_byname(2, Y)
  ) %>% 
  new_Y()
glimpse(DoubleY)
```


## What if perfectly-substitutable inputs to an intermediate industry change? Function `new_k_ps()`


## What if resources change? Function `new_R_ps()`

Both `newY()` and `new_k_ps()` estimate upstream effects of a change to the 
energy conversion change (ECC). 
`new_R_ps()` estimates *downstream* effects of a change in the
rate of resource extraction.


### Resource matrices and vectors

Resource extraction is given by the $\mat{R}$ matrix or
by the $\colvec{r}$ vector.
The resource matrix ($\mat{R}$) is Industry$\times$Product.
Its industries are usually named `Resources - <Product>`,
where `<Product>` is the name of the Product produced by that industry.
(`clean_byname()` removes `0` rows and columns for clarity.)

```{r}
UKEnergyMatsWithR$R[[1]] %>% 
  clean_byname()
```

The resource vector ($\colvec{r}$) is a Product column vector
containing Products that are resources.

```{r}
rvecs <- UKEnergyMatsWithR %>% 
  transmute(
    r = clean_byname(R) %>% 
      colsums_byname() %>% 
      transpose_byname()
  )
rvecs$r[[1]]
```

The baseline $\mat{R}$ matrix is shown above.
We can calculate the efficiency of every Industry in the ECC
using the `calc_eta_i()` function.
Let's say we want to estimate the effect of 
a 50 % reduction in production of crude oil. 
So, we cut `Resources - Crude` in half.
To execute this reduction, we'll use the `matsbyname::elementapply_byname()` function.

```{r}
half <- function(x){
  x/2
}
HalfCrude <- IO_mats %>% 
  calc_eta_i() %>% 
  mutate(
    R_prime = elementapply_byname(half, a = R, row = "Resources - Crude", col = "Crude")
  )
HalfCrude$R_prime[[1]] %>% clean_byname()
```

Now we use the `new_R()` function to estimate changes in the ECC.
But we need to calculate the efficiency of all sectors in the ECC first
using the `calc_eta_i()` function.

```{r}
HalfCrude <- HalfCrude %>% 
  new_R_ps()
glimpse(HalfCrude)
```

After re-calculating the `HalfCrude` ECC
(specifically, after calculating `U_prime`, `V_prime`, and `Y_prime`),
we can visualize the effect of lower crude oil availability
with a modified Sankey diagram.

```{r, fig.width = 7, fig.height = 4}
make_sankey(HalfCrude, R = "R_prime", U = "U_prime", V = "V_prime", Y = "Y_prime") %>% 
  extract2("Sankey") %>% # Extracts the "Sankey" column
  extract2(1) # Extracts the first row of the "Sankey" column
```

The Sankey diagram clearly shows that 
reducing the availability of crude oil (`Resources - crude`)
means that less `Transport` final demand can be satisfied.


## Conclusion


## References
