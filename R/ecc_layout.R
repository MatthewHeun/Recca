#' Layout for graph representation of an energy conversion chain
#'
#' Industries and products are interleaved from left to right,
#' starting with the first industry, followed by the first product.
#' Industries and products alternate until all products are exhausted.
#' Finally, the last industry (which should be final demand) is placed at the far right.
#'
#' @param Industries a data frame consisting of columns named
#' \code{industry_colname} and \code{stage_colname}.
#' \code{industry_colname} must contain names of industries.
#' \code{stage_colname} must contain the name of the ECC stage
#' in which the corresponding industry belongs.
#' \code{stage_colname} is 1-based, i.e., the leftmost industry stage should be stage 1;
#' the second industry stage should be stage 2, and the rightmost ( final demand)
#' stage should have the highest number.
#' Industries in the final demand industry must be included in the \code{Industries} data frame.
#' The left-to-right order of stages in the network layout generated by this function
#' is taken from the order of appearance of stages in the \code{stage_colname} column.
#' Do not include any "storage" industries in the Industries data frame;
#' rather, include "storage" indusries in the Storage data frame.
#' Storage industries
#' (such as Stock changes, International aviation and marine bunkers, and Statistical differences)
#' should be included in the \code{Industries} data frame
#' with corresponding \code{stage_colname} of \code{storage_stagename}.
#' All industries with \code{storage_stagename} are laid out along the top of the
#' network.
#' The left-to-right order of storage industries is given by
#' the appearance order of the industries in \code{industry_colname}.
#' @param Products a data frame consisting of columns named
#' \code{product_colname} and \code{stage_colname}.
#' \code{product_colname} must contain names of products.
#' \code{stage_colname} must contain the name of the ECC stage
#' in which the corresponding product belongs.
#' \code{stage_colname} is 1-based, i.e., the leftmost product stage should be stage 1;
#' the second product stage should be stage 2, and the rightmost stage
#' should have the highest number.
#' @param industry_name the name of the column in \code{Industries} containing
#'        names of industries (a string).
#'        Default is "Industries".
#' @param industry_stage_number the name of the column in \code{Industries} containing
#'        the left-to-right position of each stage (a string).
#' @param industry_group the name of an optional column in \code{Industries} containing
#'        names of groups for industries (a string).
#'        The top-to-bottom order of groups at a given stage in the in the graph
#'        is determined by the top-to-bottom
#'        order in which group names appear in the \code{Industries} data frame.
#' @param product_name the name of the column in \code{Products} containing
#'        names of products (a string).
#'        Default is "Products".
#' @param product_stage_number the name of the column in \code{product_stages} containing
#'        the left-to-right position of each stage (a string).
#' @param product_group
#'
#' @return
#' @export
#'
#' @examples
ecc_layout <- function(Industries,
                       Products,
                       industry_colname = "Industry",
                       product_colname = "Product",
                       stage_colname = "Stage",
                       storage_stagename = "Storage",
                       group_colname = "Group"){
  # Extract storage industries from the Industries data frame.
  Storage <- Industries %>%
    filter((!!as.name(stage_colname)) == storage_stagename)
  # Get the names of industries and products.
  # Left-to-right order across the network is taken from the order of appearance
  # in the respective data frames.
  inds <- Industries %>%
    filter((!!as.name(stage_colname)) != storage_stagename) %>%
    select(!!as.name(industry_colname)) %>%
    unique()
  prods <- Products %>%
    select(!!as.name(product_colname)) %>%
    unique()
  # Expect one more Industry than Products
  stopifnot(nrow(inds) == nrow(prods) + 1)
  stor <- Storage %>%
    select(!!as.name(industry_colname)) %>%
    unique()
  # Remove levels. Order is specified by order of appearance.
  levels(inds) <- NULL
  levels(prods) <- NULL
  levels(stor) <- NULL
  # Make data frames of stage numbers.
  # This process is easy for industries and products
  # but takes more calculations for storage industries (later).
  i_stage_colname <- paste0("i_", stage_colname)
  Industry_stage_order <- data.frame(temp = inds) %>%
    rownames_to_column(var = i_stage_colname) %>%
    mutate(
      !!as.name(i_stage_colname) := as.numeric(!!as.name(i_stage_colname)),
      !!as.name(i_stage_colname) := 2 * (!!as.name(i_stage_colname)) - 1
    )
  Product_stage_order <- data.frame(temp = prods) %>%
    rownames_to_column(var = i_stage_colname) %>%
    mutate(
      !!as.name(i_stage_colname) := as.numeric(!!as.name(i_stage_colname)),
      !!as.name(i_stage_colname) := 2 * (!!as.name(i_stage_colname))
    )
  # Now work on storage industries.
  # Figure out where to place them in x dimension.
  x_max <- max(Industry_stage_order[[i_stage_colname]], Product_stage_order[[i_stage_colname]])
  # 1-based coordinate system for stages.
  # Align storage industries with other industries.
  # Doing so will avoid vertical flows from products to storage.
  x_center <- (x_max + 1) / 2
  # Find out how many storage industries we have.
  N_storage <- nrow(stor)
  # Find x coordinate of first Storage industry
  x_first_storage <- x_center - (N_storage - 1) / 2
  Storage_stage_order <- data.frame(temp = stor) %>%
    mutate(
      x = seq(x_first_storage, by = 1, length.out = N_storage)
    )

  # Join these data frames
  indprodname <- paste0(stage_colname, "_name")
  Stage_coords <- rbind(Industry_stage_order %>%
                          rename(!!as.name(indprodname) := !!as.name(industry_colname)),
                        Product_stage_order %>%
                          rename(!!as.name(indprodname) := !!as.name(product_colname))
  ) %>%
    arrange(!!as.name(i_stage_colname)) %>%
    mutate(
      x = !!as.name(i_stage_colname),
      !!as.name(i_stage_colname) := NULL
    ) %>%
    rbind(
      Storage_stage_order %>%
        rename(!!as.name(indprodname) := !!as.name(industry_colname))
    )


}
